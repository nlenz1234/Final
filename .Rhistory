occupancy_numeric = case_when(
occupancy == "high" ~ 2,
occupancy == "medium" ~ 1,
occupancy == "low" ~ 0)
) %>%
dplyr::select(-connection, -occupancy)
data <- read.csv('trains_train.csv') %>%
filter(!(to %in% c("000000000", "(null)"))) %>%
mutate(
OD = paste(from, to, sep = "/"),
type = ifelse(
str_detect(vehicle, "[A-Za-z]"),
str_extract(vehicle, "^[A-Za-z]+"),
"Extra"
),
occupancy_numeric = case_when(
occupancy == "high" ~ 2,
occupancy == "medium" ~ 1,
occupancy == "low" ~ 0)
) %>%
dplyr::select(-connection, -occupancy)
stations <- read.csv('stations.csv') %>%
mutate(code = str_extract(URI, "[^/]{9}$")) %>%
dplyr::select(code, name, longitude, latitude)
unique(c(data$from, data$to))
data <- read.csv('trains_train.csv') %>%
filter(!(to %in% c("000000000", "(null)"))) %>%
filter(!(from %>% c("(null)"))) %>%
mutate(
OD = paste(from, to, sep = "/"),
type = ifelse(
str_detect(vehicle, "[A-Za-z]"),
str_extract(vehicle, "^[A-Za-z]+"),
"Extra"
),
occupancy_numeric = case_when(
occupancy == "high" ~ 2,
occupancy == "medium" ~ 1,
occupancy == "low" ~ 0)
) %>%
dplyr::select(-connection, -occupancy)
data <- read.csv('trains_train.csv') %>%
filter(!(to %in% c("000000000", "(null)"))) %>%
filter(!(from %in% c("(null)"))) %>%
mutate(
OD = paste(from, to, sep = "/"),
type = ifelse(
str_detect(vehicle, "[A-Za-z]"),
str_extract(vehicle, "^[A-Za-z]+"),
"Extra"
),
occupancy_numeric = case_when(
occupancy == "high" ~ 2,
occupancy == "medium" ~ 1,
occupancy == "low" ~ 0)
) %>%
dplyr::select(-connection, -occupancy)
stations <- read.csv('stations.csv') %>%
mutate(code = str_extract(URI, "[^/]{9}$")) %>%
dplyr::select(code, name, longitude, latitude)
unique(c(data$from, data$to))
stations <- read.csv('stations.csv') %>%
mutate(code = str_extract(URI, "[^/]{9}$")) %>%
dplyr::select(code, name, longitude, latitude) %>%
filter(code %in% unique(c(data$from, data$to)))
View(stations)
library(sf)
stations <- read.csv('stations.csv') %>%
mutate(code = str_extract(URI, "[^/]{9}$")) %>%
dplyr::select(code, name, longitude, latitude) %>%
filter(code %in% unique(c(data$from, data$to)))
stations_sf <- stations %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
ggplot(data = stations_sf) +
geom_sf(color = "grey", size = 2) +
theme_minimal() +
labs(title = "Train Stations",
x = "Longitude",
y = "Latitude")
knitr::opts_chunk$set(dev = "null", echo = TRUE)
stations <- read.csv('stations.csv') %>%
mutate(code = str_extract(URI, "[^/]{9}$")) %>%
dplyr::select(code, name, longitude, latitude) %>%
filter(code %in% unique(c(data$from, data$to)))
stations_sf <- stations %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
ggplot(data = stations_sf) +
geom_sf(color = "grey", size = 2) +
theme_minimal() +
labs(title = "Train Stations",
x = "Longitude",
y = "Latitude")
stations <- read.csv('stations.csv') %>%
mutate(code = str_extract(URI, "[^/]{9}$"),
country = ifelse(`country-code` != "be", "o", `country-code`)) %>%
dplyr::select(code, name, longitude, latitude, country) %>%
filter(code %in% unique(c(data$from, data$to)))
stations <- read.csv('stations.csv') %>%
mutate(code = str_extract(URI, "[^/]{9}$"),
country = ifelse(country-code != "be", "o", country-code)) %>%
dplyr::select(code, name, longitude, latitude, country) %>%
filter(code %in% unique(c(data$from, data$to)))
stations <- read.csv('stations.csv')
stations <- read.csv('stations.csv') %>%
mutate(code = str_extract(URI, "[^/]{9}$"),
country = ifelse(country.code != "be", "o", country.code)) %>%
dplyr::select(code, name, longitude, latitude, country) %>%
filter(code %in% unique(c(data$from, data$to)))
stations_sf <- stations %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
ggplot(data = stations_sf %>% filter(country = "be")) +
geom_sf(color = "grey", size = 2) +
theme_minimal() +
labs(title = "Train Stations",
x = "Longitude",
y = "Latitude")
stations <- read.csv('stations.csv') %>%
mutate(code = str_extract(URI, "[^/]{9}$"),
country = ifelse(country.code != "be", "o", country.code)) %>%
dplyr::select(code, name, longitude, latitude, country) %>%
filter(code %in% unique(c(data$from, data$to)))
stations_sf <- stations %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
ggplot(data = stations_sf %>% filter(country == "be")) +
geom_sf(color = "grey", size = 2) +
theme_minimal() +
labs(title = "Train Stations",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be")) +
geom_sf(color = "black", size = 2) +
theme_minimal() +
labs(title = "Train Stations",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be")) +
geom_sf(color = "grey20", size = 2) +
theme_minimal() +
labs(title = "Train Stations",
x = "Longitude",
y = "Latitude")
from_avg <- data %>%
group_by(from) %>%
summarize(avg_occupancy = mean(occupancy_numeric, na.rm = TRUE))
to_avg <- data %>%
group_by(to) %>%
summarize(avg_occupancy = mean(occupancy_numeric, na.rm = TRUE))
stations <- stations %>%
left_join(from_avg, by = c("code" = "from")) %>%
left_join(to_avg, by = c("code" = "to"))
stations <- read.csv('stations.csv') %>%
mutate(code = str_extract(URI, "[^/]{9}$"),
country = ifelse(country.code != "be", "o", country.code)) %>%
dplyr::select(code, name, longitude, latitude, country) %>%
filter(code %in% unique(c(data$from, data$to)))
stations_sf <- stations %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
ggplot(data = stations_sf %>% filter(country == "be")) +
geom_sf(color = "grey20", size = 2) +
theme_minimal() +
labs(title = "Train Stations",
x = "Longitude",
y = "Latitude")
from_avg <- data %>%
group_by(from) %>%
summarize(from_avg = mean(occupancy_numeric, na.rm = TRUE))
to_avg <- data %>%
group_by(to) %>%
summarize(to_avg = mean(occupancy_numeric, na.rm = TRUE))
stations <- stations %>%
left_join(from_avg, by = c("code" = "from")) %>%
left_join(to_avg, by = c("code" = "to"))
stations_sf <- stations %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
ggplot(data = stations_sf) +
geom_sf(aes(color = from_avg), size = 2) +
scale_color_viridis_c(option = "plasma", na.value = "grey50") +
theme_minimal() +
labs(title = "Average Occupancy: Origin",
color = "Origin Avg",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be")) +
geom_sf(aes(color = from_avg), size = 2) +
scale_color_viridis_c(option = "plasma", na.value = "grey50") +
theme_minimal() +
labs(title = "Average Occupancy: Origin",
color = "Origin Avg",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be")) +
geom_sf(aes(color = from_avg), size = 2) +
scale_color_gradient(low = "skyblue", high = "firebrick", na.value = "grey50") +
theme_minimal() +
labs(title = "Average Occupancy: Origin",
color = "Origin Avg",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be")) +
geom_sf(aes(color = from_avg), size = 2) +
scale_color_gradient(low = "grey50", high = "firebrick", na.value = "grey80") +
theme_minimal() +
labs(title = "Average Occupancy: Origin",
color = "Origin Avg",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be")) +
geom_sf(aes(color = from_avg), size = 2) +
scale_color_gradient(low = "grey50", high = "firebrick", na.value = "grey90") +
theme_minimal() +
labs(title = "Average Occupancy: Origin",
color = "Origin Avg",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be") %>% filter(!is.na(from_avg))) +
geom_sf(aes(color = from_avg), size = 2) +
scale_color_gradient(low = "grey50", high = "firebrick") +
theme_minimal() +
labs(title = "Average Occupancy: Origin",
color = "Origin Avg",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be") %>% filter(!is.na(from_avg))) +
geom_sf(aes(color = from_avg), size = 2) +
scale_color_gradient(low = "grey80", high = "firebrick") +
theme_minimal() +
labs(title = "Average Occupancy: Origin",
color = "Origin Avg",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be") %>% filter(!is.na(to_avg))) +
geom_sf(aes(color = to_avg), size = 2) +
scale_color_gradient(low = "grey80", high = "firebrick") +
theme_minimal() +
labs(title = "Average Occupancy: Destination",
color = "Dest. Avg",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be") %>% filter(!is.na(from_avg))) +
geom_sf(aes(color = from_avg), size = 2) +
scale_color_gradient(low = "grey80", high = "firebrick") +
theme_minimal() +
labs(title = "Average Occupancy: Origin",
color = "Origin Avg",
x = "Longitude",
y = "Latitude")
ggplot(data = stations_sf %>% filter(country == "be") %>% filter(!is.na(to_avg))) +
geom_sf(aes(color = to_avg), size = 2) +
scale_color_gradient(low = "grey80", high = "firebrick") +
theme_minimal() +
labs(title = "Average Occupancy: Destination",
color = "Dest. Avg",
x = "Longitude",
y = "Latitude")
od_data <- data %>%
group_by(OD) %>%
filter(n() > 3) %>%
summarize(
avg_occupancy = mean(occupancy_numeric, na.rm = TRUE),
from = first(from),
to = first(to)
)
od_with_coords <- od_data %>%
left_join(stations, by = c("from" = "code")) %>%
rename(from_long = longitude, from_lat = latitude) %>%
left_join(stations, by = c("to" = "code")) %>%
rename(to_long = longitude, to_lat = latitude)
od_lines <- od_with_coords %>%
filter(!is.na(from_long) & !is.na(to_long)) %>%
rowwise() %>%
mutate(geometry = st_sfc(st_linestring(matrix(c(from_long, from_lat, to_long, to_lat), ncol = 2, byrow = TRUE)), crs = 4326)) %>%
st_as_sf()
ggplot() +
geom_sf(data = stations_sf, color = "black", size = 2) +
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "grey20", alpha = 0.7) +
scale_size_continuous(range = c(0.5, 2), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
od_data <- data %>%
group_by(OD) %>%
filter(n() > 3) %>%
summarize(
avg_occupancy = mean(occupancy_numeric, na.rm = TRUE),
from = first(from),
to = first(to)
)
od_with_coords <- od_data %>%
left_join(stations, by = c("from" = "code")) %>%
rename(from_long = longitude, from_lat = latitude) %>%
left_join(stations, by = c("to" = "code")) %>%
rename(to_long = longitude, to_lat = latitude)
od_lines <- od_with_coords %>%
filter(!is.na(from_long) & !is.na(to_long)) %>%
rowwise() %>%
mutate(geometry = st_sfc(st_linestring(matrix(c(from_long, from_lat, to_long, to_lat), ncol = 2, byrow = TRUE)), crs = 4326)) %>%
st_as_sf()
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "grey20", alpha = 0.7) +
scale_size_continuous(range = c(0.5, 2), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "grey20", alpha = 0.7) +
scale_size_continuous(range = c(1, 3), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
od_data <- data %>%
group_by(OD) %>%
filter(n() > 2) %>%
summarize(
avg_occupancy = mean(occupancy_numeric, na.rm = TRUE),
from = first(from),
to = first(to)
)
od_with_coords <- od_data %>%
left_join(stations, by = c("from" = "code")) %>%
rename(from_long = longitude, from_lat = latitude) %>%
left_join(stations, by = c("to" = "code")) %>%
rename(to_long = longitude, to_lat = latitude)
od_lines <- od_with_coords %>%
filter(!is.na(from_long) & !is.na(to_long)) %>%
rowwise() %>%
mutate(geometry = st_sfc(st_linestring(matrix(c(from_long, from_lat, to_long, to_lat), ncol = 2, byrow = TRUE)), crs = 4326)) %>%
st_as_sf()
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "grey20", alpha = 0.7) +
scale_size_continuous(range = c(1, 3), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
od_data <- data %>%
group_by(OD) %>%
filter(n() > 3) %>%
summarize(
avg_occupancy = mean(occupancy_numeric, na.rm = TRUE),
from = first(from),
to = first(to)
)
od_with_coords <- od_data %>%
left_join(stations, by = c("from" = "code")) %>%
rename(from_long = longitude, from_lat = latitude) %>%
left_join(stations, by = c("to" = "code")) %>%
rename(to_long = longitude, to_lat = latitude)
od_lines <- od_with_coords %>%
filter(!is.na(from_long) & !is.na(to_long)) %>%
rowwise() %>%
mutate(geometry = st_sfc(st_linestring(matrix(c(from_long, from_lat, to_long, to_lat), ncol = 2, byrow = TRUE)), crs = 4326)) %>%
st_as_sf()
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "grey20", alpha = 0.7) +
scale_size_continuous(range = c(1, 3), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "grey20", alpha = 0.7) +
scale_size_continuous(range = c(1, 30), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "grey20", alpha = 0.7) +
scale_size(range = c(0.5, 2), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(width = avg_occupancy), color = "grey20", alpha = 0.7) +
scale_width(range = c(0.5, 2), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
?grom_sf
?geom_sf
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "grey20", alpha = 0.7) +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(color = avg_occupancy), color = "grey20", alpha = 0.7) +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(color = avg_occupancy), alpha = 0.7) +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(color = avg_occupancy), size = 2, alpha = 0.7) +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(color = avg_occupancy), size = 20, alpha = 0.7) +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 1) +
geom_sf(data = od_lines, aes(color = avg_occupancy), size = 20, alpha = 0.7) +
scale_color_gradient(low = "grey80", high = "firebrick") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 2) +
geom_sf(data = od_lines, aes(color = avg_occupancy), size = 20, alpha = 0.7) +
scale_color_gradient(low = "grey80", high = "firebrick") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
# 绘制站点
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 2) +
# 绘制 OD 线条，使用 `size` 控制线条粗细，`color` 可固定或动态映射
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "firebrick", alpha = 0.7) +
# 控制线条粗细的范围
scale_size_continuous(range = c(0.5, 2), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
View(od_lines)
ggplot() +
# 绘制站点
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 2) +
# 绘制 OD 线条，使用 `size` 控制线条粗细，`color` 可固定或动态映射
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "firebrick", alpha = 0.7) +
# 控制线条粗细的范围
scale_size_continuous(range = c(0.5, 200), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
# 绘制站点
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 2) +
# 绘制 OD 线条，使用 `size` 控制线条粗细，`color` 可固定或动态映射
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "firebrick", alpha = 0.7) +
# 控制线条粗细的范围
scale_size_continuous(range = c(0.5, 80), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
# 绘制站点
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 2) +
# 绘制 OD 线条，使用 `size` 控制线条粗细，`color` 可固定或动态映射
geom_sf(data = od_lines, aes(size = avg_occupancy), color = "firebrick", alpha = 0.7) +
# 控制线条粗细的范围
scale_size_continuous(range = c(0.5, 3), name = "Avg Occupancy") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggsave("output_map.pdf", width = 10, height = 7)
# 为每条线段添加缓冲区，宽度根据 avg_occupancy 动态调整
od_lines_buffered <- od_lines %>%
mutate(buffered_geom = st_buffer(geometry, dist = avg_occupancy))  # `dist` 控制宽度
# 绘制缓冲后的线段
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"),
color = "black", size = 2) +
geom_sf(data = od_lines_buffered,
aes(geometry = buffered_geom, fill = avg_occupancy),  # 使用缓冲几何对象
alpha = 0.7) +
scale_fill_gradient(low = "grey80", high = "firebrick", name = "Avg Occupancy") +
theme_minimal() +
labs(title = "Buffered OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
ggplot() +
geom_sf(data = stations_sf %>% filter(country == "be"), color = "black", size = 2) +
geom_sf(data = od_lines, aes(color = avg_occupancy), size = 2, alpha = 0.7) +
scale_color_gradient(low = "grey80", high = "firebrick") +
theme_minimal() +
labs(title = "OD Connections with Avg Occupancy",
x = "Longitude",
y = "Latitude")
