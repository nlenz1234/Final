---
title: "Script 1204"
author: "Guangze Sun"
date: "2024-12-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
Sys.setlocale("LC_TIME", "C")
```

```{r}
library(tidyverse)
library(stringr)
library(sf)
library(lubridate)
library(gridExtra)
```

```{r}
data <- read.csv('trains_train.csv') %>% 
  filter(!(to %in% c("000000000", "(null)"))) %>% 
  filter(!(from %in% c("(null)"))) %>%
  mutate(
    OD = paste(from, to, sep = "/"),
    type = ifelse(
      str_detect(vehicle, "[A-Za-z]"),
      str_extract(vehicle, "^[A-Za-z]+"),
      "Extra"
    ),
    occupancy_classifier = case_when(
      occupancy == "high" ~ 1,
      TRUE ~ 0)
  ) %>%
  dplyr::select(-connection, -occupancy)
```

```{r}
data <- data %>%
  mutate(
    time_24hr = format(parse_date_time(trimws(time), orders = "HMS p"), "%H:%M:%S"),
    datetime_combined = ymd(date) + hms(time_24hr),
    interval60 = floor_date(datetime_combined, "hour"),
    #interval30 = floor_date(datetime_combined, "30 minutes"),
    hour = hour(interval60),
    #minute = minute(interval30),
    #halfhour = hour + ifelse(minute >= 30, 0.5, 0),
    dotw = wday(interval60, label = TRUE),
    is_weekend = ifelse(dotw %in% c("Sat", "Sun"), "Weekend", "Weekday")
  )
```

```{r}
count <- data %>%
  group_by(dotw, hour) %>%
  summarise(count = n())

# count_half <- data %>%
#   group_by(dotw, halfhour) %>%
#   summarise(counthalf = n())

high_occupancy_count <- data %>%
  group_by(dotw, hour) %>%
  summarise(high_occupancy_count = sum(occupancy_classifier, na.rm = TRUE))

# high_occupancy_count_half <- data %>%
#   group_by(dotw, halfhour) %>%
#   summarise(high_occupancy_counthalf = sum(occupancy_classifier, na.rm = TRUE))

high_occupancy_rate <- data %>%
  group_by(dotw, hour) %>%
  summarise(high_occupancy_rate = mean(occupancy_classifier, na.rm = TRUE))

# high_occupancy_rate_half <- data %>%
#   group_by(dotw, halfhour) %>%
#   summarise(high_occupancy_ratehalf = mean(occupancy_classifier, na.rm = TRUE))


data <- data %>%
  left_join(count, by = c("dotw", "hour")) %>%
#  left_join(high_occupancy_count, by = c("dotw", "hour")) %>%
  left_join(high_occupancy_rate, by = c("dotw", "hour"))
# %>% left_join(count_half, by = c("dotw", "halfhour")) 
# %>% left_join(high_occupancy_count_half, by = c("dotw", "halfhour")) 
# %>% left_join(high_occupancy_rate_half, by = c("dotw", "halfhour")) 

```
```{r}
occupancy.Panel <- data %>% 
  group_by(date) %>%
  summarize(count = n(),
          high_occupancy_rate = mean(occupancy_classifier))

grid.arrange(
  ggplot(occupancy.Panel, aes(date, count)) + geom_line() + 
  labs(title="Count", x="Date", y="Count") + theme_minimal(),
  ggplot(occupancy.Panel, aes(date, high_occupancy_rate)) + geom_line() + 
  labs(title="High Occupancy Rate", x="Date", y="High Occupancy Rate") + theme_minimal(),
  top="Occupancy Data")

```

```{r}
ggplot(data %>% filter(count > 4), aes(x = dotw, y = hour, fill = high_occupancy_rate)) +
  geom_tile() + 
  scale_fill_gradient(low = "white", high = "red") +  
  labs(title = "High Occupancy Rate Across the Week",
       x = "Day of the Week",
       y = "Hour of the Day",
       fill = "High Occupancy Rate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_reverse()
```

```{r}
weather <- read.csv('weather.csv')

weather <- weather %>%
  mutate(
    date = ymd(Time),             
    month_day = format(date, "%m-%d")  
  )


data <- data %>%
  mutate(
    date = ymd(date),             
    month_day = format(date, "%m-%d")  
  ) %>%
  left_join(weather %>% select(month_day, Temperature, Precipitation), by = "month_day")
```

```{r}
weather.Panel <- data %>% 
  group_by(interval60) %>%
  summarize(Temperature = max(Temperature),
          Precipitation = max(Precipitation))

grid.arrange(
  ggplot(weather.Panel, aes(interval60,Temperature)) + geom_line() + 
  labs(title="Temperature", x="Hour", y="Temperature") + theme_minimal(),
  ggplot(weather.Panel, aes(interval60,Precipitation)) + geom_line() + 
    labs(title="Percipitation", x="Hour", y="Precipitation") + theme_minimal(),
  top="Weather Data")
```

```{r}
be <- st_read("be.shp") %>% st_transform(crs = 4326)
```

```{r}
stations <- read.csv('stations.csv') %>%
  mutate(
    code = str_extract(URI, "[^/]{9}$"),
    Weekday = as.numeric(Weekday),
    Weekend = rowMeans(cbind(as.numeric(Saturday), as.numeric(Sunday)), na.rm = TRUE)
  ) %>%
  filter(country.code == "be") %>% 
  select(code, name, longitude, latitude, Weekday, Weekend) %>% 
  filter(code %in% unique(c(data$from, data$to)))

from_avg <- data %>%
  group_by(from) %>%
  summarize(from_count = n(),
            from_avg = mean(occupancy_classifier, na.rm = TRUE))

to_avg <- data %>%
  group_by(to) %>%
  summarize(to_count = n(),
            to_avg = mean(occupancy_classifier, na.rm = TRUE))

stations <- stations %>%
  mutate(Overall = Weekday * 5/7 + Weekend * 2/7) %>%
  left_join(from_avg, by = c("code" = "from")) %>%
  left_join(to_avg, by = c("code" = "to")) %>%
  replace(is.na(.), 0) %>%
  mutate(overall_count = from_count + to_count,
         overall_avg = (from_avg * from_count + to_avg * to_count) / (from_count + to_count))

stations_sf <- stations %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

ggplot(data = stations_sf %>% filter(!is.na(from_avg))) +
  geom_sf(data = be, color = "white", alpha = 0.8) +
  geom_sf(aes(color = from_avg), size = 2) +  
  scale_color_gradient(low = "grey80", high = "firebrick") +
  theme_minimal() +
  labs(title = "Average Occupancy: Origin",
       color = "Origin Avg",
       x = "Longitude",
       y = "Latitude")

ggplot(data = stations_sf %>% filter(!is.na(to_avg))) +
  geom_sf(data = be, color = "white", alpha = 0.8) +
  geom_sf(aes(color = to_avg), size = 2) +  
  scale_color_gradient(low = "grey80", high = "firebrick") +
  theme_minimal() +
  labs(title = "Average Occupancy: Destination",
       color = "Dest. Avg",
       x = "Longitude",
       y = "Latitude")

ggplot(data = stations %>% filter(overall_count > 4)) +
  geom_point(aes(Overall, overall_avg), size = 2) +  
  theme_minimal() +
  labs(title = "Passenger Count vs Overall Occupancy",
       x = "Passenger Count",
       y = "Overall Occupancy")
```

```{r}
data <- data %>%
  filter(from %in% stations$code & to %in% stations$code)
```

```{r}
od_data <- data %>%
  group_by(OD) %>%
  #filter(n() > 3) %>%  
  summarize(
    count = n(),
    avg_occupancy = mean(occupancy_classifier, na.rm = TRUE),
    from = first(from),
    to = first(to)
  )

od_with_coords <- od_data %>%
  left_join(stations, by = c("from" = "code")) %>%
  rename(from_long = longitude, from_lat = latitude) %>%
  left_join(stations, by = c("to" = "code")) %>%
  rename(to_long = longitude, to_lat = latitude)

od_lines <- od_with_coords %>%
  filter(!is.na(from_long) & !is.na(to_long)) %>%  
  rowwise() %>%
  mutate(geometry = st_sfc(st_linestring(matrix(c(from_long, from_lat, to_long, to_lat), ncol = 2, byrow = TRUE)), crs = 4326)) %>%
  st_as_sf()

ggplot() +
  geom_sf(data = be, color = "white", alpha = 0.5) +
  geom_sf(data = stations_sf, color = "black", size = 1.5) +
  geom_sf(data = od_lines, aes(color = avg_occupancy, alpha = count), linewidth = 1) + 
  scale_alpha(range = c(0.4, 1), guide = "legend") +
  scale_color_gradient(low = "grey80", high = "firebrick") +
  theme_minimal() +
  labs(title = "OD Connections with Avg Occupancy",
       x = "Longitude",
       y = "Latitude")

```

```{r}
data <- data %>%
  mutate(type = case_when(
    type %in% c("ICE", "ICT", "ic") ~ "IC",        
    type %in% c("THA", "TRN", "Extra") ~ "Other", 
    TRUE ~ type                                   
  ))

train_type <- data %>%
  group_by(type) %>%
  summarize(count = n(),
            avg = mean(occupancy_classifier, na.rm = TRUE))

ggplot(train_type, aes(x = fct_reorder(type, avg, .desc = TRUE), y = avg)) +
  geom_col(position = position_dodge(width = 0.7), show.legend = FALSE, width = 0.7) +
  labs(
    title = "Average Occupancy by Train Type",
    x = "Train Type",
    y = "Average Occupancy"
  ) +
  theme_minimal()
```